<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>면접 훈련소 (Interview Training Center)</title>
    <style>
        :root {
            --bg-black: #0a0a0a;
            --tactical-khaki: #7b7e5e;
            --metallic-silver: #c0c0c0;
            --dim-silver: #2a2a2a;
            --highlight-khaki: #9ea17e;
        }

        body {
            background-color: var(--bg-black); color: var(--metallic-silver);
            font-family: 'Courier New', monospace; margin: 0;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }

        /* 공통 레이아웃 */
        .container { width: 90%; max-width: 800px; border: 2px solid var(--tactical-khaki); padding: 40px; background: rgba(10, 10, 10, 0.95); position: relative; }
        .hidden { display: none !important; }

        /* 타이틀 및 상태바 */
        h1 { color: var(--tactical-khaki); letter-spacing: 5px; border-bottom: 1px solid var(--dim-silver); padding-bottom: 15px; margin-top: 0; }
        .status-bar { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--tactical-khaki); margin-bottom: 10px; }

        /* 설정 화면 */
        .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; }
        .option-box { border: 1px solid var(--dim-silver); padding: 20px; cursor: pointer; text-align: center; transition: 0.3s; }
        .option-box:hover, .option-box.active { border-color: var(--tactical-khaki); background: rgba(123, 126, 94, 0.1); }
        .level-select { display: flex; gap: 20px; margin-bottom: 30px; }

        /* 훈련 화면 */
        .terminal-box { height: 250px; border: 1px solid var(--tactical-khaki); margin: 20px 0; padding: 30px; display: flex; flex-direction: column; justify-content: center; background: rgba(123,126,94,0.03); position: relative; }
        #question-text { font-size: 1.3rem; line-height: 1.6; }
        .timer-container { width: 100%; height: 6px; background: var(--dim-silver); margin-bottom: 30px; }
        #timer-bar { width: 100%; height: 100%; background: var(--tactical-khaki); transition: width 1s linear; }

        /* 복기 화면 (모달) */
        .review-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .review-card { background: var(--bg-black); border: 2px solid var(--tactical-khaki); padding: 40px; width: 80%; max-width: 500px; }
        .check-item { margin: 15px 0; font-size: 1rem; display: flex; align-items: center; gap: 15px; }
        .check-item input { width: 18px; height: 18px; accent-color: var(--tactical-khaki); }

        /* 버튼 */
        .btn { background: transparent; color: var(--tactical-khaki); border: 1px solid var(--tactical-khaki); padding: 12px 30px; cursor: pointer; font-weight: bold; letter-spacing: 2px; width: 100%; transition: 0.2s; }
        .btn:hover { background: var(--tactical-khaki); color: var(--bg-black); }
        .btn-small { width: auto; padding: 8px 20px; font-size: 0.8rem; }
        
        .auto-gauge { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--highlight-khaki); width: 0%; }
    </style>
</head>
<body>

    <div id="setup-screen" class="container">
        <h1>면접 훈련소</h1>
        <p>리허설 설정을 완료하십시오.</p>
        
        <h3>01. 레벨 선택</h3>
        <div class="level-select">
            <div class="option-box active" onclick="selectLevel('NEWBIE', this)">신입 (NEWBIE)</div>
            <div class="option-box" onclick="selectLevel('SENIOR', this)">경력 (SENIOR)</div>
        </div>

        <h3>02. 직무 선택</h3>
        <div class="setup-grid">
            <div class="option-box active">Java Backend</div>
            <div class="option-box" style="opacity: 0.5; cursor: not-allowed;">Frontend (준비중)</div>
        </div>

        <h3>03. 진행 모드</h3>
        <label><input type="radio" name="mode" value="manual" checked> 수동 진행 (직접 넘기기)</label>
        <label style="margin-left: 20px;"><input type="radio" name="mode" value="auto"> 자동 진행 (7초 텀)</label>

        <button class="btn" style="margin-top: 40px;" onclick="initTraining()">리허설 시작</button>
    </div>

    <div id="training-screen" class="container hidden">
        <div class="status-bar">
            <span id="display-level">LEVEL: NEWBIE</span>
            <span id="q-counter">PHASE: 0/0</span>
            <span id="auto-msg" style="color: var(--highlight-khaki);"></span>
        </div>
        <div class="terminal-box">
            <div id="question-text">준비 중...</div>
            <div id="auto-gauge" class="auto-gauge"></div>
        </div>
        <div class="timer-container"><div id="timer-bar"></div></div>
        <div style="display: flex; gap: 15px;">
            <button class="btn" onclick="showReview()">답변 완료 및 복기</button>
        </div>
    </div>

    <div id="review-modal" class="review-overlay hidden">
        <div class="review-card">
            <h2 style="color: var(--tactical-khaki); margin-top: 0;">체크리스트</h2>
            <p style="font-size: 0.8rem; margin-bottom: 20px;">답변에 아래 핵심 키워드가 포함되었는지 확인하세요.</p>
            <div id="checklist-content"></div>
            <button class="btn" style="margin-top: 30px;" onclick="closeReview()">확인 완료 및 다음 질문</button>
        </div>
    </div>

    <script>
    let allQuestions = {};
    let filteredKeys = [];
    let currentIndex = 0;
    let selectedLevel = 'NEWBIE'; // 기본값
    let isAutoMode = false;
    let autoTimer;
    let isDataLoaded = false;

    // 1. 데이터 로딩 (경로 확인 필수: /data/java.json)
    fetch('/data/java.json')
        .then(res => {
            if (!res.ok) throw new Error('JSON 파일을 찾을 수 없습니다.');
            return res.json();
        })
        .then(data => { 
            allQuestions = data; 
            isDataLoaded = true;
            console.log("데이터 로드 완료:", Object.keys(data).length, "개의 질문");
        })
        .catch(err => {
            console.error("데이터 로드 실패:", err);
            alert("데이터를 불러오지 못했습니다. 경로를 확인해주세요.");
        });

    // 레벨 선택 함수
    function selectLevel(level, el) {
        selectedLevel = level;
        // UI 업데이트
        document.querySelectorAll('.level-select .option-box').forEach(box => box.classList.remove('active'));
        el.classList.add('active');
        console.log("선택된 레벨:", selectedLevel);
    }

    // 2. 훈련 시작 초기화
    function initTraining() {
        if (!isDataLoaded) {
            alert("데이터가 아직 로딩 중입니다. 잠시만 기다려주세요.");
            return;
        }

        // 필터링 로직 강화: 대소문자 무관하게 비교
        filteredKeys = Object.keys(allQuestions).filter(key => {
            const qLevel = allQuestions[key].level.toUpperCase();
            return qLevel === selectedLevel.toUpperCase();
        });

        console.log("필터링된 질문 수:", filteredKeys.length);

        if (filteredKeys.length === 0) { 
            alert(`[오류] ${selectedLevel} 레벨에 해당하는 질문 데이터가 JSON에 없습니다.\n전체 질문 수: ${Object.keys(allQuestions).length}`); 
            return; 
        }
        
        isAutoMode = document.querySelector('input[name="mode"]:checked').value === 'auto';
        
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('training-screen').classList.remove('hidden');
        document.getElementById('display-level').innerText = `LEVEL: ${selectedLevel}`;
        
        currentIndex = 0; // 인덱스 초기화
        renderQuestion();
    }

    // 3. 질문 출력 및 TTS
    function renderQuestion() {
        const qKey = filteredKeys[currentIndex];
        const qData = allQuestions[qKey];
        
        if (!qData) {
            alert("질문 데이터를 불러오는 데 실패했습니다.");
            return;
        }

        document.getElementById('question-text').innerText = `Q: ${qData.question}`;
        document.getElementById('q-counter').innerText = `PHASE: ${currentIndex + 1} / ${filteredKeys.length}`;
        document.getElementById('auto-gauge').style.transition = 'none';
        document.getElementById('auto-gauge').style.width = '0%';
        document.getElementById('auto-msg').innerText = '';

        // 타이머 시각화 (60초)
        const bar = document.getElementById('timer-bar');
        bar.style.transition = 'none'; 
        bar.style.width = '100%';
        setTimeout(() => { 
            bar.style.transition = 'width 60s linear'; 
            bar.style.width = '0%'; 
        }, 100);

        // TTS 실행
        window.speechSynthesis.cancel(); // 이전 음성 중지
        const uttr = new SpeechSynthesisUtterance(qData.tts_text);
        uttr.lang = 'ko-KR'; 
        uttr.rate = 1.0;
        window.speechSynthesis.speak(uttr);
    }

    // 4. 복기 화면 열기
    function showReview() {
        window.speechSynthesis.cancel();
        clearTimeout(autoTimer);
        
        const qData = allQuestions[filteredKeys[currentIndex]];
        const listContent = document.getElementById('checklist-content');
        listContent.innerHTML = '';
        
        if (qData.eval_check_list && qData.eval_check_list.length > 0) {
            qData.eval_check_list.forEach((item, i) => {
                listContent.innerHTML += `<div class="check-item"><input type="checkbox" id="c${i}"><label for="c${i}">${item}</label></div>`;
            });
        } else {
            listContent.innerHTML = '<p>체크리스트 정보가 없습니다.</p>';
        }

        document.getElementById('review-modal').classList.remove('hidden');
    }

    // 5. 복기 닫기 및 다음 이동
    function closeReview() {
        document.getElementById('review-modal').classList.add('hidden');
        
        if (currentIndex < filteredKeys.length - 1) {
            currentIndex++;
            if (isAutoMode) {
                startAutoCount();
            } else {
                renderQuestion();
            }
        } else {
            alert("모든 리허설 과정이 종료되었습니다. 고생하셨습니다!");
            location.reload();
        }
    }

    // 6. 자동 모드 카운트다운
    function startAutoCount() {
        let sec = 7;
        const gauge = document.getElementById('auto-gauge');
        document.getElementById('auto-msg').innerText = `${sec}초 후 다음 질문 이동...`;
        
        gauge.style.transition = `width ${sec}s linear`;
        gauge.style.width = '100%';

        autoTimer = setTimeout(() => {
            renderQuestion();
        }, sec * 1000);
    }
</script>
</body>
</html>
